___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "__wm": "VGVtcGxhdGUtQXV0aG9yX1NlcnZlckNvbnRhaW5lck1vbml0b3ItU2ltby1BaGF2YQ\u003d\u003d",
  "categories": [
    "UTILITY"
  ],
  "version": 1,
  "securityGroups": [],
  "displayName": "Insert Data BigQuery Real-Time",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "This template captures real-time data from a GTM Server container and writes it to a Google BigQuery table, ensuring secure, seamless data transfer for instant analysis and reporting.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "projectId",
    "displayName": "Project ID",
    "simpleValueType": true,
    "help": "Set to the Google Cloud Project ID where the Google BigQuery is located. If the project is the same as the one running the Server container, you can leave this field empty."
  },
  {
    "type": "TEXT",
    "name": "datasetId",
    "displayName": "Dataset ID",
    "simpleValueType": true,
    "help": "Set to the Dataset ID of the BigQuery table.",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "tableId",
    "displayName": "Table ID",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "help": "Set to the Table ID of the BigQuery table."
  },
  {
    "type": "SIMPLE_TABLE",
    "name": "bigQueryData",
    "displayName": "BigQuery Table Keys",
    "simpleTableColumns": [
      {
        "defaultValue": "",
        "displayName": "Add Column",
        "name": "columnName",
        "type": "TEXT"
      },
      {
        "defaultValue": "",
        "displayName": "Add Value",
        "name": "columnValue",
        "type": "TEXT"
      }
    ],
    "newRowButtonText": "Add New",
    "help": "The Columns and Values which go into the BigQuery Table"
  }
]


___SANDBOXED_JS_FOR_SERVER___

const addEventCallback = require('addEventCallback');
const BigQuery = require('BigQuery');
const getClientName = require('getClientName');
const getEventData = require('getEventData');
const getAllEventData = require("getAllEventData");
const getTimestampMillis = require('getTimestampMillis');
const JSON = require('JSON');
const queryPermission = require('queryPermission');
const log = require('logToConsole');
const makeTableMap=require('makeTableMap');
const Object = require("Object");

const event_name = getEventData('event_name') || '';
const timestamp = getTimestampMillis();


const options = {
  ignoreUnknownValues: true,
  skipInvalidRows: false,
};

addEventCallback((containerId, eventData) => {
  
  let writeData = {};
  
 log(data.bigQueryData);
if (data.bigQueryData && data.bigQueryData.length) {
  for (let i = 0; i < data.bigQueryData.length; i += 1) {
    const elem = data.bigQueryData[i];
    if (elem.columnValue) {
      writeData[elem.columnName] = elem.columnValue;
    } else {
      Object.delete(writeData, elem.columnName);
    }
  }
}

if (data.addTimestamp) {
  writeData[data.Time_Stamp] = getTimestampMillis();
}

const rows = [writeData];
//  const event = data.bigQueryData;
//  const props= event ? [makeTableMap(event,'columnName','columnValue')] : {};
  
  log(rows);
  
  BigQuery.insert({
    projectId: data.projectId,
    datasetId: data.datasetId,
    tableId: data.tableId,
  }, rows, options, () => {
    log('BigQuery Success');
  }, (errors) => {
    log('BigQuery Failure');
    log(JSON.stringify(errors));
  });
});

  data.gtmOnSuccess();


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "read_event_metadata",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_bigquery",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedTables",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "projectId"
                  },
                  {
                    "type": 1,
                    "string": "datasetId"
                  },
                  {
                    "type": 1,
                    "string": "tableId"
                  },
                  {
                    "type": 1,
                    "string": "operation"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keyPatterns",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "event_name"
              }
            ]
          }
        },
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_container_data",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 8/12/2020, 2:55:00 PM


